# AGENTS.md — правила работы с `tasks/`

Этот файл лежит прямо в `tasks/` и объясняет:
- что где находится;
- как агент берёт задачу;
- как оформляет результат и закрывает таску;
- какие правила качества/приёмки соблюдать.

---

## 1) Структура папок

```
tasks/
  AGENTS.md
  TASKS_INDEX.md
  todo/
    A/ A1/ ... *.md
    B/ ...
    ...
  inProgress/
  completed/
```

### `todo/`
Тут лежат **все** задачи, готовые к взятию в работу, сгруппированные по этапам (A..I, X) и подпапкам (A1, A2…).

### `inProgress/`
Сюда задача **перемещается**, когда агент реально начал делать работу.

### `completed/`
Сюда задача переезжает, когда:
- критерии приёмки выполнены;
- артефакты добавлены в репо;
- обновлены индексы/заметки (если требуется).

---

## 2) Как агент выбирает задачу

### Приоритеты
1. **Сначала зависимости**: если таска ссылается на другую — бери зависимость первой.
2. **Минимизируй “ширину” изменений**: выбирай задачу, которая затрагивает один модуль/узел.
3. **Один PR = одна таска** (почти всегда).

### Откуда брать список
- `TASKS_INDEX.md` — карта задач и быстрые ссылки/ориентиры.
- Папки `todo/<Этап>/<Подэтап>/`.

### Перед началом каждой задачи
- Переключиться на `main`, подтянуть изменения (`git checkout main`, `git pull`).
- Проверить статус (`git status -sb`).
- Unity-генерёнка (Library/Logs/*.csproj/*.sln и т.п.) считается допустимой и не должна останавливать работу, но её не коммитим.

---

## 3) Жизненный цикл одной таски

1) **Claim**
- Скопируй/перемести файл из `todo/...` в **аналогичный путь** внутри `inProgress/...`.
- В начале файла таски добавь блок:
  - `Status: inProgress`
  - `Owner: <agent>`
  - `Started: YYYY-MM-DD`

2) **Implement**
- Делай только то, что описано в таске.
- Если внезапно нужно расширение — создай *новую* таску в `todo/` и ссылку “follow-up”.

3) **Verify**
- Прогони проверки (unit/editor/runtime) по требованиям таски.
- Если проверок нет — добавь минимальные (хотя бы smoke).

4) **Close**
- Обнови таску: `Status: completed`, `Finished: YYYY-MM-DD`.
- Перемести таску в `completed/...`.
- Если нужно — обнови `TASKS_INDEX.md` (галочки/статусы/ссылки).

---

## 4) Что считается “готово” (Definition of Done)

Таска считается завершённой, если выполнено всё ниже:

- ✅ Реализовано ровно то, что требуется в “Цель/Объём”.
- ✅ Все пункты “Критерии приёмки” закрыты.
- ✅ Код проходит сборку/линтер/тесты (если применимо).
- ✅ Добавлены/обновлены:
  - схемы JSON (если затрагиваются),
  - примеры конфигов,
  - минимальная документация в README/Docs (если нужно).
- ✅ Нет “скрытых” изменений: никаких левых рефакторов «пока тут был».

---

## 5) Как писать коммиты/PR

### Ветка
`task/<TASK_ID>-<short-slug>`

Пример:
`task/B2_2-rt-base-pool`

### Коммит-месседжи
- `feat(B2_2): RT_Base pool + allocation policy`
- `fix(A2_2): coalesce debounce edge-case`
- `test(I1_1): add config schema unit tests`

### PR описание
- Что сделано (2–6 пунктов).
- Как проверить.
- Какие файлы/модули ключевые.
- Ссылки на таску и зависимые таски.

---

## 6) Правила “не разнеси архитектуру”

### 6.1 Минимальный радиус изменений
Если таска про `DataStore` — не лезь в `Overlay` без причины.  
Шире одного слоя — только если таска прямо требует.

### 6.2 Никакой магии без объяснений
Если добавляешь “хитрый” кеш/пул/оптимизацию — оставь комментарий **почему** и **какой инвариант** держим.

### 6.3 Конфиги и схемы — источник правды
- Любое изменение структуры конфига → обновить схему/валидатор.
- Версионирование и миграции — по правилам из задач A1/A3/I3.

---

## 7) Стандарт оформления тасок (внутри `.md`)

Рекомендуемый заголовок и секции:

- **Цель**
- **Контекст / ссылки**
- **Объём (включено / не включено)**
- **Шаги реализации**
- **Критерии приёмки**
- **Артефакты**
- **Риски / заметки**
- **Чеклист самопроверки**

Если таска уже в таком формате — не ломай, просто дополняй по делу.

---

## 8) Что делать, если в таске не хватает данных

1. Добавь в таску раздел **Questions/Assumptions**.
2. Сформулируй допущение и продолжай, если риск приемлемый.
3. Если риск высокий — создай **подтаску** “уточнение/прототип” в `todo/`.

Главное: не превращай неопределённость в болото.

---

## 9) Порядок выполнения этапов (кратко)

- **A** — фундамент (repo/DI/config/logging/DataStore/workspace/audit).
- **B** — рендер-пайплайн/граф/биндинги.
- **C** — overlay (парсер/рендер/лейаут/виджеты/биндинги).
- **D** — локальный HTTP, stream/snapshot/view, профили вывода, on-demand.
- **E** — роли/приглашения/audit по API, базовый UI.
- **F** — команды/очередь/нормализация/правила/интеграции (Twitch/Webhook/Hotkeys).
- **G** — input nodes (webcam/tracker/filters).
- **H** — replay/encoder/storage.
- **I** — тесты/регрессии/export-import/migrations/plugins.
- **X** — reference проекты/доки интеграций (OBS).

---

## 10) Важное про стиль и безопасность

- Никаких секретов в репо: `.env`/секреты — только локально.
- Логи без персональных данных (где можно).
- API на localhost по умолчанию, внешняя экспозиция — только если задача требует.

---

## 11) Быстрый чек перед тем как “закрыть” таску

- [ ] Я сделал только то, что нужно для этой таски.
- [ ] Я обновил схемы/примеры (если трогал конфиги).
- [ ] Я добавил тест/смоук (если применимо).
- [ ] Я описал как проверить руками.
- [ ] Я переместил файл таски в `completed/` и выставил даты.

---

Если всё это соблюдать — агент будет работать стабильно и предсказуемо.
