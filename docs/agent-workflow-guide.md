# Гайд: работа с агентом (Codex), коммиты и тестирование

Этот документ описывает **как мы работаем с агентом**, как фиксируем изменения в Git, и как выстраиваем **проверки/тесты**, чтобы агент мог запускать их сам.

---

## 1) Контекст окружения

- **Источник истины**: GitHub репозиторий.
- **Unity работает на Windows** (проект лежит в `C:\Users\Yakoo\source\repos\VTubeDev`).
- **WSL используется для Git/Codex/CLI** через симлинк: `~/VTubeDev -> /mnt/c/Users/Yakoo/source/repos/VTubeDev`.
- **Ограничение**: на `/mnt/c` часть тулзов может работать медленнее, но Unity на Windows стабильнее.

---

## 2) Структура задач

Мы используем канбан-папки:

```
tasks/
  todo/
  inProgress/
  completed/
```

### Правила перемещения задач
- **Старт задачи**: агент переносит файл из `tasks/todo/` → `tasks/inProgress/`
- **Финиш задачи**: агент создаёт PR и оставляет отчёт в задаче, затем помечает `Status: ready for review`
- **Перенос в `tasks/completed/` делает пользователь** после ручной проверки/слияния

---

## 3) Шаблон файла задачи

Файл: `tasks/todo/NNN-short-title.md` (можно `.txt`, но `.md` удобнее).

```md
# NNN: Короткое название

## Цель
- ...

## Критерии приёмки
- ...

## Ограничения
- Не трогать ProjectSettings без явной причины
- Не коммитить генерёнку (.sln/.csproj/Library/Temp/UserSettings)

## Проверки (минимум)
- Unity открывается, Sandbox сцена запускается
- (если есть) batchmode тесты прошли

## Затрагиваемые файлы/папки
- unity/Assets/...
- app/...
```

### Отчёт (агент дописывает внизу)
```md
## Отчёт выполнения
- Что сделано:
- Как проверить:
- Коммиты:
- Риски/заметки:
- Follow-ups:
```

---

## 4) Как запускать агента (Codex) правильно

Запускай Codex **из релевантной директории**, чтобы он подтянул нужные `AGENTS.md`:

- Unity-задачи:
```bash
cd ~/VTubeDev/unity
codex
```

- Сервер/оркестратор:
```bash
cd ~/VTubeDev/app
codex
```

### Базовый промпт для агента (копипаст)
> Возьми задачу `tasks/todo/NNN-....md`, перемести в `tasks/inProgress/`.  
> Сначала: план (7–10 пунктов) и список файлов.  
> Затем: реализуй.  
> Затем: запусти проверки (см. раздел 6).  
> Затем: сделай 1–3 маленьких коммита с понятными сообщениями.  
> Запушь ветку и создай PR.  
> Допиши отчёт: что сделано/как проверить/коммиты/риски и пометь `Status: ready for review`.

---

## 5) Политика коммитов

### Принципы
- Маленькие, обзорные коммиты (не «свалка изменений»).
- Сообщения — в стиле:
  - `feat(unity): ...`
  - `fix(app): ...`
  - `chore: ...`
  - `docs: ...`
- Один коммит = один логический шаг.

### Обязательные проверки перед коммитом
- `git status` — убедиться, что не коммитим мусор.
- **Запрещено** коммитить:
  - `unity/Library/`
  - `unity/Temp/`
  - `unity/UserSettings/`
  - `unity/*.sln`, `unity/*.csproj`, `unity/*.vsconfig`

### Мини-набор команд
```bash
cd ~/VTubeDev
git status
git diff

git add <files>
git commit -m "feat(unity): ..."
git push
```

---

## 6) Тестирование и проверки

Есть 2 уровня: **ручной smoke** (ты) и **автомат** (агент).

### 6.1 Ручной smoke (самое главное)
Ты запускаешь Unity Editor и проверяешь:
- Проект открывается без ошибок.
- `Assets/Scenes/Sandbox.unity` запускается в Play Mode.
- Консоль без красного (warnings допустимы, но лучше не плодить).

> Этот smoke — «последняя линия обороны». Даже если автомат тесты зелёные.

---

## 6.2 Автотесты, которые агент может гонять сам

Чтобы агент мог тестировать без GUI, мы делаем **Unity Test Framework** + запуск из командной строки.

### Вариант A (рекомендуемый): PlayMode/EditMode тесты + batchmode

1) В Unity (один раз):
- Убедись, что установлен пакет **Test Framework** (обычно уже есть).

2) Структура тестов (пример):
```
unity/Assets/Tests/EditMode/...
unity/Assets/Tests/PlayMode/...
```

3) Запуск тестов из командной строки (Windows):
> ВНИМАНИЕ: агент из WSL не всегда удобно вызывает Unity.exe. Лучше сделать скрипт в `tools/` и запускать его.

---

## 7) Скрипты для тестов/проверок (чтобы агенту было просто)

Создаём `tools/` скрипты, которые:
- ищут Unity Editor путь
- запускают batchmode тесты
- возвращают корректный exit code

### 7.1 Скрипт `tools/unity-tests.ps1` (Windows PowerShell)
> Агент может запускать это через `powershell.exe` из WSL.

**План поведения скрипта:**
- Берёт путь к Unity Editor (жёстко или через env)
- Запускает:
  - EditMode tests
  - PlayMode tests
- Сохраняет результаты в `unity/TestResults/`

Пример команды, которую должен уметь делать агент:
```bash
powershell.exe -ExecutionPolicy Bypass -File tools/unity-tests.ps1
```

### 7.2 Скрипт `tools/unity-smoke.ps1`
Мини-smoke без тестов: открыть проект и выйти (проверить, что нет критических ошибок/компиляции).
Тоже через batchmode.

---

## 8) Как агенту безопасно запускать проверки

### Минимальный безопасный протокол
- Агент **не трогает** `ProjectSettings` без задачи.
- Агент **не запускает** destructive команды без спроса.
- Агент запускает:
  1) `git status` / `git diff`
  2) `powershell.exe -File tools/unity-tests.ps1` (если есть)
  3) затем коммит

### Если batchmode пока нет
Пока скриптов нет, агент в отчёте пишет:
- «Автотесты не настроены, выполнен только статический контроль (компиляция/проверка файлов). Просьба владельцу проверить в Unity: Sandbox сцена.»

---

## 9) Рекомендуемый “Definition of Done” для каждой задачи

Задача считается готовой, если:
- ✅ Реализовано требуемое.
- ✅ `git status` чистый, мусор не закоммичен.
- ✅ Пройдены проверки (batchmode тесты или отчёт о невозможности запуска).
- ✅ В задаче есть отчёт «как проверить».
- ✅ Коммиты маленькие и понятные.

---

## 10) Быстрый чеклист “как я работаю каждый день”

1. Создаю задачу в `tasks/todo/`.
2. Запускаю Codex в нужной папке (`unity/` или `app/`).
3. Агент переносит задачу в `inProgress/`, делает работу, запускает проверки, коммитит.
4. Агент переносит задачу в `completed/` и дописывает отчёт.
5. Я открываю Unity и делаю smoke в Sandbox.
6. Если ок — мерж/пуш, если нет — возвращаю задачу в `todo/` с уточнениями.

---

## 11) Приложение: что настроить позже (по мере роста)

- CI (GitHub Actions) для запуска тестов на self-hosted runner (Windows).
- Автосборка билдов.
- Линтеры/форматтеры для C# (опционально).
